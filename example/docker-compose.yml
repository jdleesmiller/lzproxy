version: '3'

services:
  search:
    build:
      context: ..
      dockerfile: example/search/Dockerfile
    command: npx lzproxy
    depends_on:
      - postgres
    environment:
      PORT: 8080
    ports:
      - '4000:8080'
    volumes:
      - ../lzproxy:/opt/lzproxy
      - ./storage:/opt/storage
      - ./search:/opt/search
      - search_lzproxy_node_modules:/opt/lzproxy/node_modules
      - search_storage_node_modules:/opt/storage/node_modules
      - search_node_modules:/opt/search/node_modules

  tasks:
    build:
      context: ..
      dockerfile: example/tasks/Dockerfile
    command: npx lzproxy
    depends_on:
      - postgres
    environment:
      PORT: 8080
    ports:
      - '5000:8080'
    volumes:
      - ../lzproxy:/opt/lzproxy
      - ./storage:/opt/storage
      - ./tasks:/opt/tasks
      - tasks_lzproxy_node_modules:/opt/lzproxy/node_modules
      - tasks_storage_node_modules:/opt/storage/node_modules
      - tasks_node_modules:/opt/tasks/node_modules

  todo:
    build:
      context: ..
      dockerfile: example/todo/Dockerfile
    command: npx lzproxy
    depends_on:
      - search
      - tasks
    environment:
      PORT: 8080
    ports:
      - '3000:8080'
    volumes:
      - ../lzproxy:/opt/lzproxy
      - ./storage:/opt/storage
      - ./todo:/opt/todo
      - todo_dist:/opt/todo/dist
      - todo_lzproxy_node_modules:/opt/lzproxy/node_modules
      - todo_storage_node_modules:/opt/storage/node_modules
      - todo_node_modules:/opt/todo/node_modules

  postgres:
    image: postgres

volumes:
  todo_dist:
  todo_lzproxy_node_modules:
  todo_storage_node_modules:
  todo_node_modules:
  tasks_lzproxy_node_modules:
  tasks_storage_node_modules:
  tasks_node_modules:
  search_lzproxy_node_modules:
  search_storage_node_modules:
  search_node_modules:
